<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gefrierschrank Marktplatz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="bg-gray-950 text-white font-sans">

  <div class="max-w-md mx-auto p-4 pb-24">
    <header class="text-center py-6">
      <h1 class="text-2xl font-bold text-indigo-500 uppercase tracking-widest">Gefrierschrank</h1>
    </header>

    <div id="cat-bar" class="flex gap-2 overflow-x-auto pb-4 no-scrollbar"></div>

    <div id="products" class="space-y-3">Lade...</div>
  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-4 z-50">
    <div class="max-w-md mx-auto flex justify-between items-center">
      <div>
        <div class="text-[10px] text-gray-400 uppercase">Gesamt</div>
        <div class="text-xl font-bold"><span id="sum">0.00</span>‚Ç¨</div>
      </div>
      <button onclick="toggleModal('cart-modal', true)" class="bg-indigo-600 px-6 py-3 rounded-xl font-bold uppercase text-sm">Warenkorb</button>
    </div>
  </div>

  <div id="cart-modal" class="modal p-4">
    <div class="bg-gray-900 w-full max-w-sm rounded-3xl p-6 flex flex-col max-h-[80vh]">
      <h2 class="text-xl font-bold mb-4 uppercase">Warenkorb</h2>
      <div id="cart-items" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
      <div class="border-t border-gray-800 pt-4 space-y-3">
        <input id="user-name" type="text" placeholder="Dein Name" class="w-full bg-gray-800 p-3 rounded-xl outline-none border border-gray-700">
        <button id="wa-btn" onclick="sendOrder()" class="w-full bg-green-600 py-4 rounded-xl font-bold uppercase shadow-lg">Per WhatsApp bestellen</button>
        <button onclick="toggleModal('cart-modal', false)" class="w-full text-gray-400 text-sm py-2">Schlie√üen</button>
      </div>
    </div>
  </div>

  <div class="text-center pb-10">
    <button onclick="adminLogin()" class="text-gray-800 text-[10px] uppercase tracking-widest">Admin Login</button>
  </div>

  <div id="admin-modal" class="modal p-4">
    <div class="bg-gray-900 w-full max-w-sm rounded-3xl p-6 overflow-y-auto max-h-[90vh]">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold uppercase text-red-500">Admin</h2>
        <button onclick="toggleModal('admin-modal', false)">‚úï</button>
      </div>
      <button onclick="openEditor()" class="w-full bg-indigo-600 py-3 rounded-xl font-bold mb-6 uppercase text-sm">Neues Produkt</button>
      <div id="admin-list" class="space-y-2"></div>
    </div>
  </div>

  <div id="edit-modal" class="modal p-4">
    <div class="bg-gray-900 w-full max-w-sm rounded-3xl p-6">
      <h2 class="text-lg font-bold mb-4 uppercase">Bearbeiten</h2>
      <div class="space-y-3">
        <input id="m-name" placeholder="Name" class="w-full bg-gray-800 p-3 rounded-xl">
        <input id="m-cat" placeholder="Kategorie" class="w-full bg-gray-800 p-3 rounded-xl">
        <div class="flex gap-2">
            <input id="m-price" type="number" step="0.01" placeholder="Preis" class="w-1/2 bg-gray-800 p-3 rounded-xl">
            <input id="m-stock" type="number" placeholder="Lager" class="w-1/2 bg-gray-800 p-3 rounded-xl">
        </div>
        <button onclick="saveProduct()" class="w-full bg-indigo-600 py-3 rounded-xl font-bold uppercase">Speichern</button>
        <button id="del-btn" onclick="deleteProduct()" class="w-full text-red-500 text-xs mt-2 uppercase">L√∂schen</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCC95uMeJcgxuHLLB-w9nuq8lM-27iwIU",
      authDomain: "gefrierschrank-marktplatz.firebaseapp.com",
      databaseURL: "https://gefrierschrank-marktplatz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gefrierschrank-marktplatz",
      storageBucket: "gefrierschrank-marktplatz.firebasestorage.app",
      messagingSenderId: "173053739867",
      appId: "1:173053739867:web:6250f88da24202aa4f907e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let data = [], cart = [], editId = null;

    // SYNC
    db.ref('products').on('value', s => {
      const val = s.val();
      data = val ? Object.keys(val).map(k => ({id: k, ...val[k]})) : [];
      render();
      renderAdmin();
    });

    function render(filter = 'all') {
      const list = document.getElementById('products');
      const cats = ['all', ...new Set(data.map(p => p.category))];
      
      document.getElementById('cat-bar').innerHTML = cats.map(c => `
        <button onclick="render('${c}')" class="px-4 py-2 rounded-xl text-xs font-bold uppercase border ${filter===c ? 'bg-indigo-600 border-indigo-500':'bg-gray-900 border-gray-800 text-gray-500'}">${c==='all'?'Alle':c}</button>
      `).join('');

      list.innerHTML = data.filter(p => filter==='all' || p.category === filter).map(p => {
        const inCart = cart.find(i => i.id === p.id)?.qty || 0;
        const avail = p.stock - inCart;
        return `
          <div class="bg-gray-900 p-4 rounded-2xl flex justify-between items-center border border-gray-800">
            <div>
              <div class="font-bold">${p.name}</div>
              <div class="text-xs ${avail > 0 ? 'text-green-500':'text-red-500'} uppercase font-bold mt-1">${avail > 0 ? 'Lager: '+avail : 'Ausverkauft'}</div>
              <div class="text-indigo-400 font-bold mt-1">${p.price.toFixed(2)}‚Ç¨</div>
            </div>
            <button onclick="addToCart('${p.id}')" class="w-12 h-12 bg-indigo-600 rounded-xl font-bold text-xl ${avail <= 0 ? 'opacity-20':''}" ${avail <= 0 ? 'disabled':''}>+</button>
          </div>
        `;
      }).join('');
    }

    function addToCart(id) {
      const p = data.find(x => x.id === id);
      const item = cart.find(i => i.id === id);
      const currentQty = item ? item.qty : 0;

      if (p.stock > currentQty) {
        if (item) item.qty++; else cart.push({ id, name: p.name, price: p.price, qty: 1 });
        updateCart();
      }
    }

    function updateCart() {
      const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
      document.getElementById('sum').textContent = total.toFixed(2);
      render();
      renderCartItems();
    }

    function renderCartItems() {
      const list = document.getElementById('cart-items');
      if (cart.length === 0) { list.innerHTML = "<div class='text-center py-10 text-gray-500'>Warenkorb ist leer</div>"; return; }
      list.innerHTML = cart.map(i => `
        <div class="flex justify-between items-center bg-gray-800 p-3 rounded-xl">
          <div class="text-sm">${i.name}</div>
          <div class="flex items-center gap-3">
            <button onclick="changeQty('${i.id}', -1)" class="w-8 h-8 bg-gray-700 rounded-lg">Ôºç</button>
            <span class="font-bold">${i.qty}</span>
            <button onclick="changeQty('${i.id}', 1)" class="w-8 h-8 bg-indigo-600 rounded-lg">Ôºã</button>
          </div>
        </div>
      `).join('');
    }

    function changeQty(id, delta) {
      const item = cart.find(i => i.id === id);
      const p = data.find(x => x.id === id);
      if (delta > 0 && p.stock > item.qty) item.qty++;
      if (delta < 0) item.qty--;
      cart = cart.filter(i => i.qty > 0);
      updateCart();
    }

    async function sendOrder() {
      const name = document.getElementById('user-name').value.trim();
      if (!name) return alert("Bitte Name eingeben");

      // BESTANDSABZUG ERST HIER BEIM KLICK
      const updates = {};
      for(let item of cart) {
        const original = data.find(p => p.id === item.id);
        if (original.stock < item.qty) return alert(original.name + " ist leider nicht mehr ausreichend da!");
        updates[`products/${item.id}/stock`] = original.stock - item.qty;
      }

      await db.ref().update(updates);

      // WhatsApp
      const text = `*Bestellung Gefrierschrank*%0Aüë§ Name: ${name}%0A%0A` + 
                   cart.map(i => `‚Ä¢ ${i.qty}x ${i.name}`).join('%0A') + 
                   `%0A%0Aüí∞ Gesamt: *${document.getElementById('sum').textContent}‚Ç¨*`;
      
      window.open(`https://wa.me/?text=${text}`, '_blank');
      cart = [];
      updateCart();
      toggleModal('cart-modal', false);
    }

    // ADMIN
    function renderAdmin() {
      document.getElementById('admin-list').innerHTML = data.map(p => `
        <div onclick="openEditor('${p.id}')" class="bg-gray-800 p-3 rounded-xl flex justify-between items-center cursor-pointer">
          <div class="text-sm font-bold">${p.name}</div>
          <div class="flex gap-4 items-center">
            <span class="text-xs font-mono text-green-500">${p.stock} Stk</span>
            <span class="text-indigo-400 font-bold">${p.price.toFixed(2)}‚Ç¨</span>
          </div>
        </div>
      `).join('');
    }

    function openEditor(id = null) {
      editId = id;
      const p = id ? data.find(x => x.id === id) : { name: '', category: '', price: '', stock: '' };
      document.getElementById('m-name').value = p.name;
      document.getElementById('m-cat').value = p.category;
      document.getElementById('m-price').value = p.price;
      document.getElementById('m-stock').value = p.stock;
      document.getElementById('del-btn').style.display = id ? 'block' : 'none';
      toggleModal('edit-modal', true);
    }

    function saveProduct() {
      const p = {
        name: document.getElementById('m-name').value,
        category: document.getElementById('m-cat').value,
        price: parseFloat(document.getElementById('m-price').value),
        stock: parseInt(document.getElementById('m-stock').value)
      };
      if (editId) db.ref('products/' + editId).update(p); else db.ref('products').push(p);
      toggleModal('edit-modal', false);
    }

    function deleteProduct() { if(confirm("L√∂schen?")) { db.ref('products/' + editId).remove(); toggleModal('edit-modal', false); } }
    function toggleModal(id, show) { document.getElementById(id).classList.toggle('active', show); }
    function adminLogin() { if(prompt("PW:") === "030199") toggleModal('admin-modal', true); }
  </script>
</body>
</html>
