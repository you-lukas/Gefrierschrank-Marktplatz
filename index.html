<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCC95uMeJcgxuHLLB-w9nuq8lM-27iwIU",
      authDomain: "gefrierschrank-marktplatz.firebaseapp.com",
      databaseURL: "https://gefrierschrank-marktplatz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gefrierschrank-marktplatz",
      storageBucket: "gefrierschrank-marktplatz.firebasestorage.app",
      messagingSenderId: "173053739867",
      appId: "1:173053739867:web:6250f88da24202aa4f907e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let products = [], cart = [], globalCodes = [], activeMultiplier = 1, flatDiscount = 0, activeCodeName = null, activeCodeId = null;
    let timerInterval = null, timeLeft = 900;

    // --- NEU: ZUR√úCKBUCHEN BEI AKTUALISIERUNG ODER SCHLIESSEN ---
    window.addEventListener('beforeunload', (event) => {
      if (cart.length > 0) {
        // Wir nutzen eine Loop, um alles zur√ºckzugeben, bevor die Seite stirbt
        cart.forEach(i => {
          const p = products.find(x => x.id === i.id);
          if (p) {
            db.ref('products/' + i.id).update({ stock: p.stock + i.qty });
          }
        });
      }
    });

    // LISTENERS
    db.ref('products').on('value', s => { 
        const data = s.val(); products = data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : []; 
        renderProducts(); renderInventory(); updateAnalyticsDisplay();
    });
    db.ref('codes').on('value', s => { 
      const data = s.val() || {};
      const now = new Date().toISOString().split('T')[0];
      globalCodes = Object.keys(data).map(k => ({id:k, ...data[k]}));
      globalCodes.forEach(c => { if(c.expiry && c.expiry < now) db.ref('codes/'+c.id).remove(); });
      renderCodes();
    });
    db.ref('orders').on('value', s => { updateOrderTable(s.val()); });

    function applyGlobalCode() {
      const val = document.getElementById("discountInput").value.trim().toUpperCase();
      const c = globalCodes.find(x => x.code === val);
      if(c) {
          if(c.type === 'percent') { activeMultiplier = (1 - c.value/100); flatDiscount = 0; }
          else { flatDiscount = c.value; activeMultiplier = 1; }
          activeCodeName = c.code;
          activeCodeId = c.id;
          renderCart(); alert("Code '" + c.code + "' aktiviert!");
      } else {
          activeMultiplier = 1; flatDiscount = 0; activeCodeName = null; activeCodeId = null;
          renderCart(); alert("Code ung√ºltig.");
      }
    }

    async function orderWhatsApp() {
      const name = document.getElementById("c_name").value.trim();
      const info = document.getElementById("c_msg").value.trim();
      const total = parseFloat(document.getElementById("totalPrice").textContent);
      
      const orderItems = cart.map(i => {
          const pNow = products.find(x => x.id === i.id);
          return { name: i.name, qty: i.qty, log: `${i.initialStock} ‚ûî ${pNow ? pNow.stock : '?'}` };
      });

      if(activeCodeId) {
          const currentCode = globalCodes.find(x => x.id === activeCodeId);
          if(currentCode && currentCode.type === 'once') {
              await db.ref('codes/' + activeCodeId).remove();
          }
      }

      await db.ref('orders').push({ 
          customer: name, info, items: orderItems, total, date: new Date().toLocaleString('de-DE'), done: false, usedCode: activeCodeName 
      });

      let waText = `Bestellung von *${name}*:%0A%0A`;
      cart.forEach(i => { waText += `‚Ä¢ ${i.qty}x ${i.name}%0A`; });
      waText += `%0AGesamt: *${total.toFixed(2)}‚Ç¨*`;
      if(activeCodeName) waText += `%0A%0A*Rabatt-Code:* ${activeCodeName}`;
      if(info) waText += `%0A%0A*Info:* ${info}`;

      // Wichtig: Cart leeren BEVOR WhatsApp √∂ffnet, damit der beforeunload-Listener nicht doppelt bucht
      const tempCart = [...cart];
      cart = []; 

      window.open(`https://wa.me/?text=${waText}`, "_blank");
      
      flatDiscount = 0; activeMultiplier = 1; activeCodeName = null; activeCodeId = null;
      stopTimer(); renderCart(); closeModals();
      document.getElementById("c_name").value = "";
      document.getElementById("c_msg").value = "";
      document.getElementById("discountInput").value = "";
    }

    function updateOrderTable(orders) {
      const tbody = document.getElementById("orderTableBody");
      if(!tbody || !orders) return;
      const keys = Object.keys(orders).reverse();
      document.getElementById("openOrderBadge").innerText = keys.filter(k => !orders[k].done).length;
      tbody.innerHTML = keys.map(k => {
        const o = orders[k];
        return `<tr class="${o.done ? 'opacity-30' : ''} border-b border-gray-800/20">
            <td class="p-4"><input type="checkbox" ${o.done ? 'checked' : ''} onchange="db.ref('orders/${k}').update({done: this.checked})"></td>
            <td class="p-4 text-[9px] text-gray-500">${o.date}</td>
            <td class="p-4"><span class="font-bold">${o.customer}</span>${o.info ? `<span class="info-text">"${o.info}"</span>` : ''}</td>
            <td class="p-4 text-[10px]">${o.items ? o.items.map(i => `<div>${i.qty}x ${i.name} <span class="stock-log">(${i.log})</span></div>`).join("") : ""}</td>
            <td class="p-4 text-right whitespace-nowrap">${o.usedCode ? `<span class="promo-badge">${o.usedCode}</span>` : ''}<span class="text-green-400 font-bold">${o.total ? o.total.toFixed(2) + '‚Ç¨' : '-'}</span></td>
            <td class="p-4"><button onclick="if(confirm('L√∂schen?')) db.ref('orders/${k}').remove()">üóëÔ∏è</button></td></tr>`;
      }).join('');
    }

    async function saveNewCode() {
      const n = document.getElementById("newCodeName").value.trim().toUpperCase();
      const v = parseFloat(document.getElementById("newCodeValue").value);
      const t = document.getElementById("newCodeType").value;
      const e = document.getElementById("newCodeExpiry").value;
      if(n && v) { 
          await db.ref('codes').push({ code: n, value: v, type: t, expiry: e, created: new Date().toLocaleDateString('de-DE') }); 
          document.getElementById("newCodeName").value=""; 
      }
    }

    function renderCodes() {
      document.getElementById("codeList").innerHTML = globalCodes.map(c => `<div class="bg-gray-800 p-2 rounded border border-gray-700 text-[10px] mb-1"><div class="flex justify-between items-center mb-1"><span class="font-bold text-indigo-400">${c.code}</span><button onclick="db.ref('codes/${c.id}').remove()" class="text-red-500">‚úï</button></div><div class="flex justify-between text-gray-400"><span>${c.type === 'percent' ? c.value+'%' : c.value+'‚Ç¨'} (${c.type === 'once' ? 'Einmalig' : 'Dauer'})</span><span>Bis: ${c.expiry || '‚àû'}</span></div></div>`).join("");
    }

    async function addToCart(id) {
      const p = products.find(x => x.id === id);
      if (p && p.stock > 0) {
          const oldStock = p.stock;
          await db.ref('products/' + id).update({ stock: p.stock - 1 });
          const item = cart.find(i => i.id === id);
          if (item) item.qty++; else { const price = p.sale > 0 ? p.price * (1 - p.sale/100) : p.price; cart.push({ id, name: p.name, price, qty: 1, initialStock: oldStock }); }
          startTimer(); renderCart();
      }
    }
    function renderCart() {
      const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
      let total = subtotal * activeMultiplier - flatDiscount;
      if(total < 0) total = 0;
      document.getElementById("cartItems").innerHTML = cart.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span><span>${(i.price * i.qty).toFixed(2)} ‚Ç¨</span></div>`).join("") || "Warenkorb leer";
      document.getElementById("totalPrice").textContent = total.toFixed(2);
      document.getElementById("timerDisplay").style.display = cart.length > 0 ? "block" : "none";
    }
    function renderProducts() {
      const list = document.getElementById("productList"); if(!list) return; list.innerHTML = "";
      products.forEach(p => {
        const salePrice = p.sale > 0 ? p.price * (1 - p.sale/100) : p.price;
        list.innerHTML += `<div class="bg-gray-900 p-4 rounded-2xl flex justify-between items-center border border-gray-800 relative">${p.sale > 0 ? `<div class="absolute top-0 left-0 bg-red-600 text-[8px] font-bold px-1.5 py-0.5 rounded-br-lg z-10">-${p.sale}%</div>` : ''}<div><div class="font-bold text-gray-100">${p.name}</div><div class="text-sm mt-1"><span class="${p.sale > 0 ? 'text-red-400' : 'text-indigo-400'} font-bold">${salePrice.toFixed(2)}‚Ç¨</span><span class="text-gray-600 ml-2 text-xs">‚Ä¢ ${p.stock <= 0 ? 'Ausverkauft' : p.stock + ' Stk.'}</span></div></div><button onclick="addToCart('${p.id}')" class="bg-indigo-600 btn-plus rounded-xl font-bold flex items-center justify-center text-xl ${p.stock <= 0 ? 'opacity-20' : ''}" ${p.stock <= 0 ? 'disabled' : ''}>+</button></div>`;
      });
    }
    function renderInventory() {
      const tbody = document.getElementById("inventoryTable"); if(!tbody) return;
      tbody.innerHTML = products.map(p => `<tr class="border-b border-gray-800/30"><td class="p-2"><input onchange="db.ref('products/${p.id}').update({name: this.value})" value="${p.name}" class="bg-transparent font-bold outline-none w-24"></td><td class="p-2"><input type="number" onchange="db.ref('products/${p.id}').update({stock: parseInt(this.value)})" value="${p.stock}" class="admin-val-input text-indigo-400"></td><td class="p-2"><input type="number" step="0.01" onchange="db.ref('products/${p.id}').update({price: parseFloat(this.value)})" value="${p.price}" class="admin-val-input text-green-400"></td><td class="p-2"><input type="number" onchange="db.ref('products/${p.id}').update({sale: parseInt(this.value)})" value="${p.sale || 0}" class="admin-val-input text-red-400"></td><td class="p-2"><button onclick="if(confirm('L√∂schen?')) db.ref('products/${p.id}').remove()">‚úï</button></td></tr>`).join('');
    }
    function clearCart() { 
      cart.forEach(async i => { 
        const p = products.find(x => x.id === i.id); 
        if(p) await db.ref('products/'+i.id).update({stock: p.stock + i.qty}); 
      }); 
      cart = []; stopTimer(); renderCart(); 
    }
    function startTimer() { if(timerInterval) return; timeLeft = 900; timerInterval = setInterval(() => { timeLeft--; let m = Math.floor(timeLeft/60); let s = timeLeft%60; document.getElementById("timerDisplay").innerText = `${m}:${s<10?'0':''}${s}`; if(timeLeft<=0){clearCart();alert("Zeit abgelaufen!");}}, 1000); }
    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
    function triggerAdminMenu() { if (prompt("PW:") === "030199") openModal('managerModal'); }
    function openModal(id) { closeModals(); document.getElementById(id).classList.replace("modal-hidden", "modal-visible"); }
    function closeModals() { document.querySelectorAll('.fixed').forEach(m => m.classList.replace("modal-visible", "modal-hidden")); }
    function checkForm() { const n = document.getElementById("c_name").value.trim(); const b = document.getElementById("finalOrderBtn"); b.disabled = n.length <= 1; b.classList.toggle("opacity-30", n.length <= 1); }
    function openCheckout() { if (cart.length) openModal('checkoutModal'); }
    async function saveToFirebase() { const n = document.getElementById("m_name").value, p = parseFloat(document.getElementById("m_price").value) || 0, s = parseInt(document.getElementById("m_stock").value) || 0; if(n) { await db.ref('products').push({ name:n, price:p, stock:s, sale:0 }); openModal('managerModal'); } }
    function openAnalytics() { openModal('analyticsModal'); document.getElementById("restock_select").innerHTML = products.map(p => `<option value="${p.id}">${p.name} (${p.stock})</option>`).join(""); }
    function updateAnalyticsDisplay() { let v = 0, s = 0; products.forEach(p => { v += (p.price * p.stock); s += p.stock; }); if(document.getElementById("stat_totalValue")) document.getElementById("stat_totalValue").innerText = v.toFixed(2) + "‚Ç¨"; if(document.getElementById("stat_totalStock")) document.getElementById("stat_totalStock").innerText = s; }
    async function submitRestock() { const id = document.getElementById("restock_select").value, qty = parseInt(document.getElementById("restock_qty").value); if(!id || isNaN(qty)) return; const p = products.find(x => x.id === id), oldS = p.stock, newS = p.stock + qty; await db.ref('products/' + id).update({ stock: newS }); await db.ref('orders').push({ customer: "üì¶ NACHSCHUB", items: [{ name: p.name, qty: qty, log: `${oldS} ‚ûî ${newS}` }], date: new Date().toLocaleString('de-DE'), done: true }); document.getElementById("restock_qty").value = ""; }
  </script>
